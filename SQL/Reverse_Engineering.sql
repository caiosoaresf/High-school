DROP DATABASE IF EXISTS REVERSE_ENGINEERING;
CREATE DATABASE REVERSE_ENGINEERING;
USE REVERSE_ENGINEERING;

CREATE TABLE SUBJECT (
	COD3 VARCHAR(7) NOT NULL,
    NOM VARCHAR(40) NOT NULL,
    CREDITS INT NOT NULL,
    DEPARTMENT VARCHAR(60) NOT NULL,
    CONSTRAINT PRIMARY KEY (COD3)
);

CREATE TABLE REQUIREMENTS (
    COD3_SUBJECT VARCHAR(7) NOT NULL,
    COD3_REQUIREMENTS VARCHAR(7) NOT NULL,
    CONSTRAINT PRIMARY KEY (COD3_SUBJECT, COD3_REQUIREMENTS),
    CONSTRAINT FK_PR FOREIGN KEY (COD3_SUBJECT) REFERENCES SUBJECT (COD3) ON DELETE CASCADE
);

CREATE TABLE STUDENT(
	COD3 INT NOT NULL,
    NOM VARCHAR(20) NOT NULL,
    TERM INT NOT NULL,
    DEPARTMENT_PRINCIPAL VARCHAR(60) NOT NULL,
    CONSTRAINT PRIMARY KEY (COD3)
);

CREATE TABLE CL4SS(
    COD3 INT NOT NULL,
    COD3_SUBJECT VARCHAR(7) NOT NULL, 
	SEMESTER VARCHAR(2) NOT NULL,
    Y3AR INT NOT NULL,
    PROFESSOR VARCHAR(60),
    CONSTRAINT PRIMARY KEY (COD3),
    CONSTRAINT FK_CL4SS FOREIGN KEY (COD3_SUBJECT) REFERENCES SUBJECT (COD3) ON DELETE RESTRICT
);

CREATE TABLE TRANSCRIPT(
    COD3_STUDENT INT NOT NULL,
    COD3_CL4SS INT NOT NULL,
    NOTA VARCHAR(1) NOT NULL,
    CONSTRAINT PRIMARY KEY (COD3_STUDENT, COD3_CL4SS),
    CONSTRAINT FK_H_E FOREIGN KEY (COD3_STUDENT) REFERENCES STUDENT (COD3) ON DELETE CASCADE,
    CONSTRAINT FK_H_T FOREIGN KEY (COD3_CL4SS) REFERENCES CL4SS (COD3) ON DELETE CASCADE
);

INSERT INTO SUBJECT VALUES ('DCC1310', 'Introdução à Ciência da Computação', 4, 'DCC');
INSERT INTO SUBJECT VALUES ('DCC3320', 'Estrutuda de Dados', 4, 'DCC');
INSERT INTO SUBJECT VALUES ('MAT2410', 'Matemática Discreta', 3, 'MAT');
INSERT INTO SUBJECT VALUES ('DCC3380', 'Banco de Dados', 3, 'DCC');

INSERT INTO REQUIREMENTS VALUES ('DCC3380', 'DCC3320');
INSERT INTO REQUIREMENTS VALUES ('DCC3380', 'MAT2410');
INSERT INTO REQUIREMENTS VALUES ('DCC3320', 'DCC1310');

INSERT INTO STUDENT VALUES (17, 'João', 1, 'DCC');
INSERT INTO STUDENT VALUES (8, 'José', 2, 'DCC');

INSERT INTO CL4SS VALUES (85, 'MAT2410', 'II', 91, 'King');
INSERT INTO CL4SS VALUES (92, 'DCC1310', 'II', 91, 'Anderson');
INSERT INTO CL4SS VALUES (102, 'DCC3320', 'II', 92, 'Knuth');
INSERT INTO CL4SS VALUES (112, 'MAT2410', 'II', 92, 'Chang');
INSERT INTO CL4SS VALUES (119, 'DCC1310', 'II', 92, 'Anderson');
INSERT INTO CL4SS VALUES (135, 'DCC3380', 'II', 92, 'Stone');

INSERT INTO TRANSCRIPT VALUES (17, 112, 'B');
INSERT INTO TRANSCRIPT VALUES (17, 119, 'C');
INSERT INTO TRANSCRIPT VALUES (8, 85, 'A');
INSERT INTO TRANSCRIPT VALUES (8, 92, 'A');
INSERT INTO TRANSCRIPT VALUES (8, 102, 'B');
INSERT INTO TRANSCRIPT VALUES (8, 135, 'A');

SELECT E.NOM, COUNT(DISTINCT H.NOTA) AS 'NOTA'
FROM STUDENT E, TRANSCRIPT H
WHERE E.COD3 = H.COD3_STUDENT
GROUP BY E.NOM
HAVING COUNT(H.NOTA) > 2
ORDER BY E.NOM;

SELECT SUM(D.CREDITS)
FROM SUBJECT D
WHERE D.DEPARTMENT IN (
	SELECT E.DEPARTMENT_PRINCIPAL
    FROM STUDENT E
);
